<!-- templates/index.html - Multi-Strategy Dashboard template with Favicon -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetardTrader</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    
    <link rel="stylesheet" href="/static/style.css">
    <meta http-equiv="refresh" content="60">
</head>
<body>
    <div id="toast-container"></div>

    <div class="container">
        <!-- Strategy Tabs -->
        <div class="tabs-container">
            <div class="tabs-header">
                {% for strategy in strategies %}
                <div class="tab-button" data-strategy="{{ strategy.get('name', 'unknown') }}" onclick="switchToStrategy('{{ strategy.get('name', 'unknown') }}')">
                    <span class="tab-name">{{ strategy.get('display_name', strategy.get('name', 'Unknown')) }}</span>
                </div>
                {% endfor %}
                <div class="tab-button tab-create" onclick="showCreateStrategy()">
                    <span class="tab-name">+</span>
                </div>
            </div>
        </div>

        <!-- Empty State (when no strategies exist) -->
        {% if not strategies %}
        <div class="empty-state">
            <button class="create-strategy-btn" onclick="showCreateStrategy()">Create Your First Strategy</button>
        </div>
        {% endif %}

        <!-- Create Strategy Form -->
        <div id="create-strategy-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New Strategy</h3>
                    <span class="modal-close" onclick="hideCreateStrategy()">&times;</span>
                </div>
                <form id="create-strategy-form">
                    <div class="form-group">
                        <label for="strategy-name">Strategy Name:</label>
                        <input type="text" id="strategy-name" required 
                               placeholder="e.g., momentum_strategy" 
                               pattern="[a-zA-Z0-9_]{3,50}"
                               title="Alphanumeric and underscores only, 3-50 characters">
                    </div>
                    <div class="form-group">
                        <label for="strategy-long-symbol">Long (optional):</label>
                        <input type="text" id="strategy-long-symbol" placeholder="e.g., MSTU">
                    </div>
                    <div class="form-group">
                        <label for="strategy-short-symbol">Short (optional):</label>
                        <input type="text" id="strategy-short-symbol" placeholder="e.g., MSTZ">
                    </div>
                    <div class="form-group">
                        <label for="strategy-cash">Initial Cash Balance:</label>
                        <input type="number" id="strategy-cash" step="0.01" value="0" min="0">
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="hideCreateStrategy()">Cancel</button>
                        <button type="submit">Create Strategy</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Strategy Content Tabs -->
        {% for strategy in strategies %}
        <div class="strategy-content" id="strategy-{{ strategy.get('name', 'unknown') }}" style="display: none;">
            
            <!-- Webhook URLs Section -->
            <div class="webhook-section">
                <div class="webhook-card">
                    <h2>Webhooks</h2>
                    <div class="webhook-url-group">
                        <label>Long:</label>
                        <div class="url-input-group">
                            <input type="text" readonly value="{{ request.base_url }}{{ strategy.get('name', 'unknown') }}/long" id="long-url-{{ strategy.get('name', 'unknown') }}">
                            <button onclick="copyToClipboard('long-url-{{ strategy.get('name', 'unknown') }}')">Copy</button>
                        </div>
                    </div>
                    <div class="webhook-url-group">
                        <label>Short:</label>
                        <div class="url-input-group">
                            <input type="text" readonly value="{{ request.base_url }}{{ strategy.get('name', 'unknown') }}/short" id="short-url-{{ strategy.get('name', 'unknown') }}">
                            <button onclick="copyToClipboard('short-url-{{ strategy.get('name', 'unknown') }}')">Copy</button>
                        </div>
                    </div>
                    <div class="webhook-url-group">
                        <label>Close:</label>
                        <div class="url-input-group">
                            <input type="text" readonly value="{{ request.base_url }}{{ strategy.get('name', 'unknown') }}/close" id="close-url-{{ strategy.get('name', 'unknown') }}">
                            <button onclick="copyToClipboard('close-url-{{ strategy.get('name', 'unknown') }}')">Copy</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Symbols Section -->
            <div class="symbols-section">
                <div class="symbols-card">
                    <h2>Symbols</h2>
                    <div class="symbol-display">
                        <div class="symbol-item">
                            <span class="label">Long:</span>
                            <span class="symbol-value">{{ strategy.get('long_symbol') or "Not set" }}</span>
                        </div>
                        <div class="symbol-item">
                            <span class="label">Short:</span>
                            <span class="symbol-value">{{ strategy.get('short_symbol') or "Not set" }}</span>
                        </div>
                    </div>
                    
                    <form class="update-form">
                        <h3>Update Symbols</h3>
                        <div class="symbols-form-group">
                            <div class="form-field">
                                <label>Long:</label>
                                <input type="text" class="long-symbol-input" 
                                       value="{{ strategy.get('long_symbol') or '' }}" 
                                       placeholder="e.g., MSTU">
                            </div>
                            <div class="form-field">
                                <label>Short:</label>
                                <input type="text" class="short-symbol-input" 
                                       value="{{ strategy.get('short_symbol') or '' }}" 
                                       placeholder="e.g., MSTZ">
                            </div>
                            <button type="button" onclick="updateStrategySymbols('{{ strategy.get('name', 'unknown') }}')">Update</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Manual Trading Section -->
            <div class="manual-section">
                <div class="manual-card">
                    <h2>Override</h2>
                    <div class="manual-controls">
                        <button type="button" class="manual-btn force-long" onclick="forceStrategyLong('{{ strategy.get('name', 'unknown') }}')">Force Long</button>
                        <button type="button" class="manual-btn force-short" onclick="forceStrategyShort('{{ strategy.get('name', 'unknown') }}')">Force Short</button>
                        <button type="button" class="manual-btn force-close" onclick="forceStrategyClose('{{ strategy.get('name', 'unknown') }}')">Force Close</button>
                    </div>
                </div>
            </div>
            
            <!-- Cash Balance Section -->
            <div class="cash-section">
                <div class="cash-card">
                    <h2>Options BP</h2>
                    <div class="cash-amount">${{ "%.2f"|format(strategy.get('cash_balance', 0) or 0) }}</div>
                    <div class="cash-details">
                        <div>Strategy: {{ strategy.get('display_name', strategy.get('name', 'Unknown')) }}</div>
                        <div>Last updated: 
                            {% if strategy.get('cash_info') and strategy.cash_info.get('staleness') %}
                                {% set staleness = strategy.cash_info.staleness %}
                                {% if staleness.get('days', 0) > 0 %}
                                    {{ staleness.days }} days
                                {% endif %}
                                {% if staleness.get('hours', 0) > 0 %}
                                    {{ staleness.hours }} hours
                                {% endif %}
                                {{ staleness.get('minutes', 0) }} minutes ago
                            {% else %}
                                Just now
                            {% endif %}
                        </div>
                    </div>
                    
                    <form class="update-form">
                        <div class="form-group">
                            <input type="number" class="cash-amount-input" step="0.01" required 
                                   placeholder="Enter new balance">
                            <button type="button" onclick="updateStrategyCash('{{ strategy.get('name', 'unknown') }}')">Update</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Cooldown Section -->
            <div class="cooldown-section">
                <div class="cooldown-card">
                    <h2>Cooldown</h2>
                    {% set cooldown = strategy.get('cooldown', {}) %}
                    {% if cooldown.get('active') %}
                        <div class="cooldown-active">
                            <div class="cooldown-label">Cooldown Active</div>
                            <div class="cooldown-timer">
                                Time remaining: {{ cooldown.get('remaining', {}).get('hours', 0) }}h {{ cooldown.get('remaining', {}).get('minutes', 0) }}m
                            </div>
                            <div class="cooldown-end">
                                Ends at: {{ cooldown.get('end_time', 'Unknown') }}
                            </div>
                        </div>
                    {% else %}
                        <div class="cooldown-inactive">
                            <div class="cooldown-label">Cooldown Inactive</div>
                            <div>Ready to process signals normally</div>
                        </div>
                    {% endif %}
                    
                    <div class="cooldown-controls">
                        <button type="button" class="cooldown-btn" onclick="startStrategyCooldown('{{ strategy.get('name', 'unknown') }}')">Start Cooldown</button>
                        <button type="button" class="cooldown-btn" onclick="stopStrategyCooldown('{{ strategy.get('name', 'unknown') }}')">Stop Cooldown</button>
                    </div>
                </div>
            </div>
            
            <!-- API Call History Section -->
            <div class="api-section">
                <div class="api-calls">
                    <h2>API Logs</h2>
                    {% if strategy.get('api_calls') and strategy.api_calls|length > 0 %}
                        {% for call in strategy.api_calls|reverse %}
                            <div class="api-call">
                                <div class="api-call-header">
                                    <div class="timestamp">{{ call.get('timestamp', 'Unknown') }}</div>
                                    <div class="status {{ call.get('response', {}).get('status', 'unknown') }}">
                                        {{ call.get('response', {}).get('status', 'Unknown') }}
                                    </div>
                                </div>
                                <div class="api-call-content">
                                    <div class="request">
                                        <h4>Request</h4>
                                        <pre>{{ call.get('request', {}) | tojson(indent=2) }}</pre>
                                    </div>
                                    <div class="response">
                                        <h4>Response</h4>
                                        <pre>{{ call.get('response', {}) | tojson(indent=2) }}</pre>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-api-calls">No API calls recorded yet for this strategy</div>
                    {% endif %}
                </div>
            </div>

            <!-- Strategy Actions -->
            <div class="strategy-actions">
                <button type="button" class="delete-strategy-btn" onclick="deleteStrategy('{{ strategy.get('name', 'unknown') }}')">Delete Strategy</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <script src="/static/dashboard.js"></script>
    <script>
        // Initialize the first tab or show empty state
        document.addEventListener('DOMContentLoaded', function() {
            {% if strategies %}
                {% set first_strategy = strategies[0] %}
                switchToStrategy('{{ first_strategy.get('name', 'unknown') }}');
            {% endif %}
        });
    </script>
</body>
</html>
